# 商品卡片增强功能

## 新增功能概述

根据用户需求，我们为商品列表页的商品卡片增加了以下新功能：

### 1. 更新时间 ⏰
- **显示位置**: 商品卡片底部时间信息区域
- **数据来源**: `last_updated` 字段（来自 `price_history.recorded_at`）
- **显示格式**: 相对时间（如"2小时前"、"1天前"）
- **图标**: 🕐 时钟图标

### 2. 价格变动时间 📈
- **显示位置**: 商品卡片底部时间信息区域
- **数据来源**: `last_price_change` 字段（来自 `price_alerts.created_at`）
- **显示格式**: 相对时间（如"3天前变价"）
- **图标**: 📊 图表图标
- **说明**: 显示最近一次价格变动的时间

### 3. 评分 ⭐
- **显示位置**: 商品名称下方
- **数据来源**: `score` 字段（来自 `price_history.score`）
- **显示格式**: 星级评分 + 数字评分（如 ⭐⭐⭐⭐⭐ 4.8）
- **星级显示**: 5星制，支持半星显示
- **颜色**: 金色星星

### 4. 评价量 💬
- **显示位置**: 评分旁边
- **数据来源**: `evaluation_count` 字段（来自 `price_history.evaluation_count`）
- **显示格式**: 括号内数字（如"(156评价)"）
- **格式化**: 大数字使用千分位分隔符

### 5. 折扣力度 🏷️
- **显示位置**: 价格区域
- **计算方式**: `(原价 - 现价) / 原价 * 100%`
- **显示格式**: 红色标签（如"40% OFF"）
- **显示条件**: 仅当有原价且现价低于原价时显示
- **图标**: 🏷️ 标签图标

## 技术实现

### 数据库更改
1. **新增字段**: 在 `price_history` 表中添加了 `score` 字段
2. **数据迁移**: 创建了 `migrate-database.js` 脚本来添加新字段
3. **API查询**: 修改了商品查询SQL，包含价格变动时间信息

### 前端组件更新
1. **工具函数**: 在 `utils.js` 中添加了新的工具函数：
   - `calculateDiscount()`: 计算折扣力度
   - `formatRating()`: 格式化评分
   - `generateStarRating()`: 生成星级评分HTML
   - `formatRelativeTime()`: 格式化相对时间

2. **商品卡片组件**: 更新了 `components.js` 中的 `createProductCard()` 函数
   - 支持网格视图和列表视图
   - 添加了新的信息显示区域
   - 保持了原有的响应式设计

3. **CSS样式**: 在 `components.css` 中添加了新的样式类：
   - `.price-section`: 价格区域样式
   - `.rating-section`: 评分区域样式
   - `.time-info`: 时间信息样式
   - `.discount-badge`: 折扣标签样式

### API更新
1. **商品列表API**: 修改了 `/api/products` 接口，返回新字段
2. **商品详情API**: 修改了 `/api/products/:code` 接口，返回新字段
3. **数据格式化**: 在 `formatProduct()` 方法中处理新字段

## 显示逻辑

### 网格视图
```
┌─────────────────────┐
│     商品图片        │
├─────────────────────┤
│ 商品名称            │
│ 商品编号            │
│ ⭐⭐⭐⭐⭐ 4.8 (156评价) │
│ ¥59  ¥99  40% OFF   │
│ 🕐 更新: 2小时前     │
│ 📊 变价: 3天前       │
│ 颜色: 白色, 黑色     │
│ 尺码: S, M, L       │
└─────────────────────┘
```

### 列表视图
```
┌────┬─────────────────────────────────────────┐
│图片│ 商品名称                                │
│    │ 商品编号                                │
│    │ ⭐⭐⭐⭐⭐ 4.8 (156评价)                    │
│    │ ¥59 ¥99 40% OFF 有库存 销量:3498        │
│    │ 🕐 更新:2小时前  📊 变价:3天前           │
│    │ 颜色: 白色, 黑色  尺码: S, M, L, XL     │
└────┴─────────────────────────────────────────┘
```

## 测试页面

创建了 `frontend/test-enhanced-cards.html` 测试页面，可以：
- 查看网格视图和列表视图的效果
- 测试真实数据和模拟数据
- 验证所有新功能的显示效果

## 兼容性

- ✅ 保持了原有的所有功能
- ✅ 响应式设计，适配移动端
- ✅ 向后兼容，没有数据时优雅降级
- ✅ 支持现有的筛选和排序功能

## 使用方法

1. 启动后端API服务器：`node server.js`
2. 启动前端服务器：`cd frontend && node server.js`
3. 访问主应用：`http://localhost:8080`
4. 访问测试页面：`http://localhost:8080/test-enhanced-cards.html`

## 注意事项

- 评分数据需要通过数据抓取获得，当前数据库中的评分为默认值0
- 价格变动时间依赖于价格警报记录，新商品可能没有此信息
- 折扣力度仅在有原价且现价低于原价时显示
- 所有新功能都有优雅的降级处理，缺少数据时不会影响页面显示
